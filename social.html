<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>m</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
/* --- UNCHANGED STYLES --- */
:root{
  --bg:#ffffff;
  --fg:#0b0b0d;
  --muted:rgba(11,11,13,.45);
  --line:rgba(11,11,13,.1);
  --paper:#f6f7f8;
  --paper-border:rgba(11,11,13,.06);
  --accent:hsl(210 90% 56%);
  --accent-soft:hsla(210,90%,56%,.14);
  --green:hsl(150 70% 45%);
  --yellow:hsl(45 90% 55%);
  --radius:16px;
  --pad:16px;
  --max:720px;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#000;
    --fg:#fff;
    --muted:rgba(255,255,255,.45);
    --line:rgba(255,255,255,.12);
    --paper:#0c0d10;
    --paper-border:rgba(255,255,255,.08);
    --accent:hsl(210 90% 62%);
    --accent-soft:hsla(210,90%,62%,.18);
  }
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,
    "Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  display:flex;
  justify-content:center;
}
.app{
  width:100%;
  max-width:var(--max);
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:22px 16px 18px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.logo-link{
  display:flex;
  align-items:center;
  height:28px;
  color:var(--accent);
  text-decoration:none;
}
.logo-link svg{height:100%}
.presence{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  color:var(--muted);
}
.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--yellow);
}
.feed{flex:1;padding:20px 0 120px}
.post{
  margin:0 16px 14px;
  padding:var(--pad);
  background:var(--paper);
  border-radius:var(--radius);
}
.post time{font-size:11px;color:var(--muted)}
.post p{margin:8px 0 10px;font-size:15px;line-height:1.55}
.actions{font-size:12px;display:flex;gap:16px;color:var(--muted)}
.actions span{cursor:pointer}
.actions span:hover{color:var(--accent)}
.thread{
  margin-top:10px;
  padding-left:12px;
  border-left:2px solid var(--accent-soft);
}
.composer{
  position:fixed;
  bottom:0;
  width:100%;
  max-width:var(--max);
  background:var(--bg);
  border-top:1px solid var(--line);
  padding:12px 16px 16px;
}
textarea{
  width:100%;
  min-height:56px;
  resize:none;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 14px;
  font-size:15px;
  background:var(--paper);
  color:var(--fg);
}
textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 2px var(--accent-soft);
}
.meta{
  margin-top:6px;
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:var(--muted);
}
button#send{
  border:1px solid var(--line);
  background:var(--paper);
  color:var(--fg);
  padding:6px 12px;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}
button#send:hover{border-color:var(--accent);color:var(--accent)}
</style>
</head>

<body>
<div class="app">

<header>
  <a href="https://www.omnicorpusa.com" class="logo-link">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <path d="M16 42c0-14 16-14 16 0v14 M32 42c0-14 16-14 16 0"
        fill="none" stroke="currentColor" stroke-width="6"
        stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>
  <div class="presence">
    <div class="dot" id="dot"></div>
    <span id="state">connecting</span>
  </div>
</header>

<section id="feed" class="feed"></section>

<div class="composer">
  <textarea id="input" placeholder="Write."></textarea>
  <div class="meta">
    <span id="stats">0 words</span>
    <button id="send">Send</button>
  </div>
</div>

</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const supabase = window.supabase.createClient(
  "https://stywczdwpclejhxovpod.supabase.co",
  "sb_publishable_ObcAyL8IIArKAXUC0m1cSA_xcC6qg0j"
);

/* AUTH REQUIRED */
const { data:auth } = await supabase.auth.getSession();
if(!auth.session) location.replace("/");
const user = auth.session.user;

/* ELEMENTS */
const input = document.getElementById("input");
const feed = document.getElementById("feed");
const dot = document.getElementById("dot");
const stateEl = document.getElementById("state");
const sendBtn = document.getElementById("send");
const stats = document.getElementById("stats");

/* UTILS */
const words=t=>t.trim()?t.trim().split(/\s+/).length:0;
const timeAgo=t=>{
  const s=(Date.now()-new Date(t))/1000;
  if(s<60)return"now";
  if(s<3600)return Math.floor(s/60)+"m";
  if(s<86400)return Math.floor(s/3600)+"h";
  return new Date(t).toLocaleDateString();
};

/* PRESENCE */
setInterval(()=>{
  supabase.from("presence").upsert({
    user_id:user.id,
    last_seen:new Date().toISOString()
  });
},5000);

supabase.channel("presence")
  .on("postgres_changes",{event:"*",schema:"public",table:"presence"},()=>{
    stateEl.textContent="online";
    dot.style.background="var(--green)";
  }).subscribe();

/* POSTS */
async function load(){
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false})
    .limit(200);
  render(data||[]);
}

supabase.channel("posts")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},load)
  .subscribe();

sendBtn.onclick=async()=>{
  const text=input.value.trim();
  if(!text)return;
  await supabase.from("posts").insert({
    user_id:user.id,
    content:text
  });
  input.value="";
  stats.textContent="0 words";
};

input.oninput=()=>stats.textContent=`${words(input.value)} words`;

function render(posts){
  feed.innerHTML="";
  posts.filter(p=>!p.parent_id)
    .forEach(p=>renderPost(p,posts,feed));
}

function renderPost(p,all,container){
  const el=document.createElement("div");
  el.className="post";
  el.innerHTML=`
    <time>${timeAgo(p.created_at)}</time>
    <p>${p.content}</p>
    <div class="actions">
      <span onclick="reply('${p.id}')">reply</span>
    </div>`;
  container.appendChild(el);

  all.filter(c=>c.parent_id===p.id)
    .forEach(c=>{
      const t=document.createElement("div");
      t.className="thread";
      renderPost(c,all,t);
      container.appendChild(t);
    });
}

window.reply=async(id)=>{
  const text=prompt("Replyâ€¦");
  if(!text)return;
  await supabase.from("posts").insert({
    user_id:user.id,
    content:text,
    parent_id:id
  });
};

load();
</script>

</body>
</html>
